<!DOCTYPE html>
<html>

<head>
    <title>k means</title>
    <link href="themes/prism.css" rel="stylesheet" />
    <style>
        div.code-image-pair {
            overflow: auto;
        }

        div.code-image-pair>pre {
            float: left;
        }

        div.code-image-pair>img {
            float: right;
        }
    </style>
</head>

<body style="background-color: #f5f2f0;">
    <div hidden>http://prismjs.com/download.html?themes=prism-solarizedlight&languages=markup+css+clike+javascript+c+cpp+python</div>
    <script src="https://cdn.jsdelivr.net/npm/clipboard@1/dist/clipboard.min.js"></script>
    <script src="prism.js"></script>
    <h1>i'm going to implement k-means to compress an image</h1>
    my roommate described the idea to me the other day and said that I should try it myself
    <h2>k means is</h2>
    <p>an iterative algorithm for clustering</p>
    <h3>given</h3>
    <ul>a bunch of points</ul>
    <ul>k = target number number of clusters</ul>
    <h3>do</h3>
    <ol>randomly pick a starting location for each of the k cluster centers</ol>
    <ol>for each point in the graph determine which cluster it's closest to</ol>
    <ol>move each cluster point to the center of the points that belong to that cluster</ol>
    <p>hmm, that doesn't seem to be a very clear explination</p>

    <h2>pictures and text</h2>
    <p>this is the picture that I want to compress</p>
    <p>it would be smaller if it used fewer colors</p>
    <p>i'm going to use k-means to determine what colors it should use</p>
    <a href="https://www.pexels.com/photo/close-up-view-colorful-candy-chocolate-65547/">
        <img src="resources/mnms.jpg" alt="Photo by Caio Resende from Pexels" height=200>
    </a>

    <h3>I wonder if i can make a basic scatter plot</h3>
    <div class="code-image-pair">

        <pre class="line-numbers" data-src="src/basic_scatter.py">
        </pre>
        <img height=300 src="resources/k_means.1.png" />
    </div>
    <p>it looks like i can</p>

    <h3>i wonder if i can add colors to the points</h3>
    <div class="code-image-pair">

        <pre class="line-numbers" data-src="src/add_colors.py">
        </pre>
        <img src="resources/k_means.2.png" height=300/>
    </div>
    <p>it looks like i can</p>

    <h3>i wonder if i can plot in 3d</h3>
    <div class="code-image-pair">

        <pre class="line-numbers" data-src="src/first_3d.py">
    </pre>
        <img src="resources/k_means.3.png" height=300/>
    </div>
    <p>it looks like i can</p>
    <p>I don't know what the 111 is for though</p>

    <h3>100 points, the rendering lags on my computer</h3>
    <div class="code-image-pair">

        <pre class="line-numbers" data-src="src/render_lag.py">
</pre>
        <img src="resources/k_means.4.png" width=400/>
    </div>

    <h3>I wonder if I can render a little video offline instead of viewing it in real time</h3>
    <p>I set the view angle for the plot and then save a screenshot to a file</p>
    <p>i do this a bunch of times and stitch the pics together into a gif</p>
    <div class="code-image-pair">

        <pre class="line-numbers" data-src="src/render_offline.py">
</pre>
        <img src="resources/plotPics.9.gif" width=400/>
    </div>
    <p>this is how I stitched the pics together into a gif</p>

    <pre class="line-numbers">
        <code class="language-bash">
convert -delay 10 *.png plotPics9.gif
</code>
</pre>

    <h3>better</h3>
    <p>the previous example has a bug where I'm still using degrees instead of radians for the view rotation so it doesn't go
        in a circle but more of an oval</p>
    <div class="code-image-pair">

        <pre class="line-numbers" data-src="src/better.py">
</pre>
        <img src="resources/plotPics.11.gif" height=300/>
    </div>
    <p>this is how I stitched the pics together into a gif</p>

    <pre class="line-numbers">
        <code class="language-bash">
convert -delay 10 *.png plotPics9.gif
</code>
</pre>

    <h3>open a picture and plot the points</h3>
    <p>this is way too slow</p>
    <div class=code-image-pair>

        <pre class="line-numbers" data-src="src/open_a_pic_and_plot_points.py">
</pre>
        <img src="resources/plotPics.14.gif" height=400/>
    </div>

    <h3>gnuplot data from file</h3>
    <p>write the data to a file and open it with gnuplot</p>
    <p>it is way faster to generate the gif, it glitches though and I'm not sure why</p>
    <div class=code-image-pair>
        <pre class="line-numbers" data-src="src/gnu_plot_data_from_file.py"></pre>
        <pre class="line-numbers" data-src="src/k-means.gnuplot"></pre>
        <img src="resources/rot3.gif" height=400/>
    </div>

    <h3>do the calculation in c++</h3>
    <p>let's get some speed. it'll be pretty easy to implement this in c++ and then we'll get to compare the speed to python</p>
    <p>so far, we've only seen that actually drawing the plot is slow, i don't have an idea of how fast the algorithm runs but
        I have a hunch that it's going to be slow</p>
    <p>and I bet I can get some pretty graphs out of this</p>
    <h4>step one. set up googletest</h4>
    <p>i want to jump into running the code as soon as i finish each piece so I'll use googletest to run my nugets of code</p>
    <pre>
    <code class="language-bash">
    mkdir build
    cd build
    cmake ..
    make kmeansTest
    test/kmeansTest
</code>
</pre>
    <pre>
    <code class="language-cpp">
            #include "gtest/gtest.h"
            #include "gmock/gmock.h"
            #include "kmeans.hpp"
            
            TEST(thisPasses, helloHello) {
                ASSERT_EQ("hello", "hello");
            }
            TEST(thisFails,helloWorld) {
                ASSERT_EQ("hello", "world");
            }
    </code>
</pre>
    <pre>
    <code class="language-bash">
            Running main() from gtest_main.cc
            [==========] Running 2 tests from 2 test cases.
            [----------] Global test environment set-up.
            [----------] 1 test from thisPasses
            [ RUN      ] thisPasses.helloHello
            [       OK ] thisPasses.helloHello (0 ms)
            [----------] 1 test from thisPasses (0 ms total)
            
            [----------] 1 test from thisFails
            [ RUN      ] thisFails.helloWorld
            /mnt/c/Users/richie/Documents/github/k-means/test/kmeansTest.cpp:14: Failure
            Expected equality of these values:
              "hello"
                Which is: 0x43f9bf
              "world"
                Which is: 0x43fa11
            [  FAILED  ] thisFails.helloWorld (0 ms)
            [----------] 1 test from thisFails (1 ms total)
            
            [----------] Global test environment tear-down
            [==========] 2 tests from 2 test cases ran. (1 ms total)
            [  PASSED  ] 1 test.
            [  FAILED  ] 1 test, listed below:
            [  FAILED  ] thisFails.helloWorld
            
             1 FAILED TEST
    </code>
</pre>
    <p>I made a point type and a function to subtract them</p>
    <pre>
    <code class="language-cpp">
template &lt;int n&gt;
using Point = array&lt;int, n&gt;;

auto minus(auto a, auto b) {
    decltype(a) result;
    transform(begin(a), end(a), begin(b), begin(result), std::minus&lt;int&gt;());
    return result;
}
auto plus(auto a, auto b) {
    decltype(a) result;
    transform(begin(a), end(a), begin(b), begin(result), std::plus&lt;int&gt;());
    return result;
}
    </code>
</pre>
    <p>I made a distance function</p>
    <pre class="language-cpp">
        <code>
            double distance(auto a, auto b) {
                auto f = [](double a, double b) { return a + pow(b, 2); };
                auto result = minus(a, b);
                auto sum = accumulate(begin(result), end(result), 0, f);
                return sqrt(sum);
            }
        </code>
    </pre>
    <p>I made a function to find the average of a cluster of points</p>
    <pre class="language-cpp">
        <code>
            template &lt;unsigned long n, unsigned long x&gt;
            auto average(array&lt;Point&lt;auto, n&gt;, x&gt; arr) {
                auto init = arr[0];
                auto divide = [=](auto a) -&gt; double { return (double)a / arr.size(); };
                auto p = [](auto a, auto b) { return plus(a, b); };
                auto acc = accumulate(begin(arr) + 1, end(arr), init, p);
                Point&lt;double, n&gt; result;
                transform(begin(acc), end(acc), begin(result), divide);
                return result;
            }
        </code>
    </pre>


</body>

</html>